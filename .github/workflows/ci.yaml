name: C++ CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake libboost-all-dev libpqxx-dev clang-format
    
    - name: Setup Crow framework
      run: |
        # Create the expected Crow directory structure for CMake
        mkdir -p ../crow/Crow/include
        cp -r Crow/include/crow.h ../crow/Crow/include/
        cp -r Crow/include/crow ../crow/Crow/include/
    
    - name: Configure and build
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        make -j$(nproc)
    
    - name: Build tests
      run: |
        mkdir -p build_tests
        cd build_tests
        cmake ../tests
        make -j$(nproc)
    
    - name: Copy test config
      run: cp tests/config_test.json config_test.json
    
    - name: Run tests
      run: ./build_tests/test_simple
    
    - name: Check code formatting
      run: |
        clang-format --version
        find . -name '*.cpp' -o -name '*.h' | xargs clang-format --style=file --output-replacements-xml | grep "<replacement " && (echo "Code is not properly formatted" && exit 1) || echo "Code formatting is OK"

