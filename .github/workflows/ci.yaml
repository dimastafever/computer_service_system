name: C++ CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake libboost-all-dev libpqxx-dev libgtest-dev googletest clang-format
    
    - name: Build GTest (if needed)
      if: steps.check_gtest.outputs.exists != 'true'
      run: |
        # In case libgtest-dev doesn't provide compiled libraries
        sudo apt-get install -y cmake libgtest-dev
        cd /usr/src/googletest
        sudo cmake .
        sudo make
        sudo cp *.a /usr/lib/ || true
    
    - name: Setup Crow framework
      run: |
        # Clone Crow framework
        git clone --depth 1 https://github.com/CrowCpp/Crow.git Crow
        # CMake expects Crow at ../Crow/include relative to build dir
        mkdir -p ../Crow/include
        cp -r Crow/include/* ../Crow/include/
        ls -la ../Crow/include/ | head -5
    
    - name: Configure and build
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        make -j$(nproc)
    
    - name: Build tests
      run: |
        mkdir -p build_tests
        cd build_tests
        cmake ../tests
        make -j$(nproc)
    
    - name: Copy test config
      run: cp tests/config_test.json config_test.json
    
    - name: Run tests
      run: ./build_tests/test_simple
    
    - name: Check code formatting
      run: |
        clang-format --version
        find . -name '*.cpp' -o -name '*.h' | xargs clang-format --style=file --output-replacements-xml | grep "<replacement " && (echo "Code is not properly formatted" && exit 1) || echo "Code formatting is OK"

